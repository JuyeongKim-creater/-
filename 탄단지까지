# ===== Colab Dashboard (ì—‘ì…€ DB Â· í•˜ë£¨ ê¸°ì¤€ Â· AI ì¶”ì²œ ì¹´ë“œ í¬í•¨) =====
# íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© ì •ë³´ê°€ ì¶”ê°€ëœ ë²„ì „ì…ë‹ˆë‹¤.

# ì„¤ì¹˜
!pip -q install plotly ipywidgets pandas numpy openpyxl xlrd==2.0.1

import re, io, datetime as dt, os, numpy as np, pandas as pd
import ipywidgets as W
from IPython.display import display, clear_output
from google.colab import files

# ê³µí†µ ìœ í‹¸
def to_ts(d): return pd.Timestamp(d).normalize()
TODAY_TS = to_ts(dt.date.today())

# ì—…ë¡œë”/ë²„íŠ¼
uploader = W.FileUpload(accept=".xlsx,.xls", multiple=True, description="ì—‘ì…€ ì—…ë¡œë“œ(ì„ íƒ)")
load_btn = W.Button(description="ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°", button_style="primary")
load_out = W.Output()

# ê¸°ë³¸ íŒŒì¼(ì—†ì–´ë„ ë¨)
DEFAULT_FILES = [
    "/mnt/data/20250408_ìŒì‹DB.xlsx",
    "/mnt/data/20241230_ê°€ê³µì‹í’ˆDB_133569ê±´.xlsx",
    "/mnt/data/ì „êµ­í†µí•©ì‹í’ˆì˜ì–‘ì„±ë¶„ì •ë³´_ì›ì¬ë£Œì„±ì‹í’ˆ_í‘œì¤€ë°ì´í„°-20250815.xls",
]

# ì—‘ì…€ ì½ê¸°: í™•ì¥ìë³„ ì—”ì§„ ìë™
def read_excel_any(path_or_bytes, filename=None):
    # Ensure filename is a string before processing
    filename_str = str(filename) if filename is not None else ""

    if isinstance(path_or_bytes, (str, os.PathLike)):
        ext = os.path.splitext(str(path_or_bytes))[1].lower()
    else:
        # Use the string version of filename here
        ext = os.path.splitext(filename_str or "")[1].lower()
    engine = "xlrd" if ext == ".xls" else "openpyxl"
    xls = pd.ExcelFile(path_or_bytes, engine=engine)
    df = pd.read_excel(xls, sheet_name=xls.sheet_names[0], engine=engine)
    return df

# DB ë³‘í•© ë¡œë”©
def build_food_db():
    dfs = []
    # ì—…ë¡œë“œ íŒŒì¼ ìš°ì„ 
    if uploader.value:
        for _, meta in uploader.value.items():
            content = meta["content"]; fname = meta["metadata"]["name"]
            try:
                dfs.append(read_excel_any(io.BytesIO(content), filename=fname))
            except Exception as e:
                print(f"ì—…ë¡œë“œ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {fname} -> {e}")
    # ì—…ë¡œë“œ ì—†ìœ¼ë©´ ê¸°ë³¸ ê²½ë¡œ
    if not dfs:
        for fname in DEFAULT_FILES:
            if os.path.exists(fname):
                try:
                    dfs.append(read_excel_any(fname, filename=fname))
                except Exception as e:
                    print(f"ê¸°ë³¸ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {fname} -> {e}")
    if not dfs:
        raise RuntimeError("ì—‘ì…€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    dfs = [d for d in dfs if isinstance(d, pd.DataFrame) and not d.empty]
    if not dfs:
        raise RuntimeError("ì—‘ì…€ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
    return pd.concat(dfs, ignore_index=True)

# [ìˆ˜ì •ë¨] ì •ê·œí™”: ì´ë¦„/ê¸°ì¤€ëŸ‰/ì—´ëŸ‰ -> per100, íƒ„ì†Œ ì¶”ì • + íƒ„/ë‹¨/ì§€ ì¶”ê°€
def normalize_food_table(df_raw):
    df = df_raw.copy()
    df.rename(columns={c: str(c).strip() for c in df.columns}, inplace=True)

    # ì»¬ëŸ¼ ì°¾ê¸°
    name_col = next((c for c in df.columns if ("ì‹í’ˆëª…" in c) or ("ì œí’ˆëª…" in c) or ("í’ˆëª…" in c)), None)
    unit_col = next((c for c in df.columns if ("ì˜ì–‘ì„±ë¶„í•¨ëŸ‰ê¸°ì¤€ëŸ‰" in c) or ("ê¸°ì¤€" in c) or ("ë‹¨ìœ„" in c) or ("1íšŒì œê³µëŸ‰" in c)), None)
    kcal_col = next((c for c in df.columns if (("ì—ë„ˆì§€" in c) and ("kcal" in c)) or ("kcal" in c.lower()) or ("ì—´ëŸ‰" in c)), None)
    prot_col = next((c for c in df.columns if ("ë‹¨ë°±ì§ˆ" in c) and ("g" in c.lower())), None)
    fat_col  = next((c for c in df.columns if ("ì§€ë°©" in c) and ("g" in c.lower())), None)
    carb_col = next((c for c in df.columns if ("íƒ„ìˆ˜í™”ë¬¼" in c) and ("g" in c.lower())), None)

    if not all([name_col, unit_col, kcal_col]):
        raise ValueError(f"í•„ìš” ì»¬ëŸ¼ ì—†ìŒ(ì‹í’ˆëª…/ê¸°ì¤€ëŸ‰/kcal). ì˜ˆì‹œ: {list(df.columns)[:12]}")

    def parse_unit(s):
        s = str(s)
        m = re.search(r'([\d\.]+)\s*(g|ê·¸ëŒ|ml|mL|ë°€ë¦¬ë¦¬í„°)', s)
        if m:
            amt = float(m.group(1))
            u = m.group(2)
            unit = "ml" if u.lower() in ["ml","mL","ë°€ë¦¬ë¦¬í„°"] else "g"
            return amt, unit
        return 100.0, "g"

    parsed = df[unit_col].apply(parse_unit)
    df["base_amount"] = parsed.apply(lambda x: x[0])
    df["base_unit"]   = parsed.apply(lambda x: x[1])

    df["kcal_per1"] = pd.to_numeric(df[kcal_col], errors="coerce") / df["base_amount"]
    
    # ì˜ì–‘ì„±ë¶„ per1 ê³„ì‚°
    optional_cols = {"protein": prot_col, "fat": fat_col, "carb": carb_col}
    for name, col in optional_cols.items():
        if col:
            df[f"{name}_per1"] = pd.to_numeric(df[col], errors="coerce") / df["base_amount"]

    # ìµœì¢… ì»¬ëŸ¼ ëª©ë¡
    keep = [name_col, "base_unit", "kcal_per1"]
    if "protein_per1" in df.columns: keep.append("protein_per1")
    if "fat_per1" in df.columns: keep.append("fat_per1")
    if "carb_per1" in df.columns: keep.append("carb_per1")

    out = df[keep].rename(columns={name_col: "ì‹í’ˆëª…"})
    out = (out
           .dropna(subset=["ì‹í’ˆëª…","kcal_per1"])
           .groupby(["ì‹í’ˆëª…","base_unit"], as_index=False)
           .mean(numeric_only=True))

    # 100g/ml ë‹¨ìœ„ë¡œ ë³€í™˜
    out["per100"] = (out["kcal_per1"] * 100).round(1)
    out["carbon_per100_gCO2"] = (out["per100"] * 0.5).round(1)
    if "protein_per1" in out.columns:
        out["protein_per100"] = (out["protein_per1"] * 100).round(1)
    if "fat_per1" in out.columns:
        out["fat_per100"] = (out["fat_per1"] * 100).round(1)
    if "carb_per1" in out.columns:
        out["carb_per100"] = (out["carb_per1"] * 100).round(1)
        
    return out


FOOD_DB = None

def load_data(_=None):
    global FOOD_DB
    with load_out:
        clear_output(wait=True); print("ì—‘ì…€ ë¡œë”©/ì •ê·œí™” ì¤‘â€¦")
    try:
        raw = build_food_db()
        FOOD_DB = normalize_food_table(raw)
        if FOOD_DB is None or FOOD_DB.empty:
            raise RuntimeError("ì •ê·œí™” ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì»¬ëŸ¼ëª…ì„ í™•ì¸í•˜ì„¸ìš”.")
        with load_out:
            clear_output(wait=True)
            cnt = len(FOOD_DB)
            dist = FOOD_DB["base_unit"].value_counts().to_dict()
            print(f"ë¡œë“œ ì™„ë£Œ: ì´ {cnt}ê°œ ì‹í’ˆ (ë‹¨ìœ„ ë¶„í¬: {dist})")
        # í™œì„±í™”
        search_btn.disabled = False
        search_results.disabled = False
    except Exception as e:
        FOOD_DB = None
        with load_out:
            clear_output(wait=True)
            print("âŒ ìŒì‹DB ë¡œë“œ ì‹¤íŒ¨:", e)
            print("- ì—…ë¡œë“œ íŒŒì¼ì˜ ì²« ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€")
            print("- í•„ìˆ˜ ì»¬ëŸ¼(ì‹í’ˆëª…/ê¸°ì¤€ëŸ‰/ì—ë„ˆì§€[kcal]) ì¡´ì¬ ì—¬ë¶€")
            print("- .xls/.xlsx í™•ì¥ìì™€ ì—”ì§„ ë§¤ì¹­ í™•ì¸")
    render()
load_btn.on_click(load_data)

# TDEE
def calc_tdee(age, sex, height_cm, weight_kg, activity):
    if sex == "ë‚¨": bmr = 10*weight_kg + 6.25*height_cm - 5*age + 5
    else: bmr = 10*weight_kg + 6.25*height_cm - 5*age - 161
    factor = {"ê±°ì˜ ìš´ë™ ì•ˆí•¨":1.2, "ê°€ë²¼ìš´ ìš´ë™":1.375, "ë³´í†µ ìš´ë™":1.55, "ê°•í•œ ìš´ë™":1.725, "ì•„ì£¼ ê°•í•¨":1.9}[activity]
    return round(bmr*factor, 0)

age = W.Dropdown(description="ë‚˜ì´", options=[(f"{y}ì„¸", y) for y in range(10, 81)], value=25)
height = W.Dropdown(description="í‚¤", options=[(f"{h} cm", h) for h in range(140, 201)], value=170)
weight = W.Dropdown(description="ëª¸ë¬´ê²Œ", options=[(f"{w} kg", w) for w in range(35, 121)], value=65)
sex = W.ToggleButtons(description="ì„±ë³„", options=["ë‚¨","ì—¬"], value="ë‚¨")
activity = W.Dropdown(description="í™œë™ì§€ìˆ˜", options=["ê±°ì˜ ìš´ë™ ì•ˆí•¨","ê°€ë²¼ìš´ ìš´ë™","ë³´í†µ ìš´ë™","ê°•í•œ ìš´ë™","ì•„ì£¼ ê°•í•¨"], value="ë³´í†µ ìš´ë™")
calc_btn = W.Button(description="ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°", button_style="primary")
tdee_out = W.HTML("<b>ê¶Œì¥ ì¹¼ë¡œë¦¬: 2000 kcal</b>")
def on_calc_clicked(_):
    tdee = calc_tdee(age.value, sex.value, height.value, weight.value, activity.value)
    tdee_out.value = f"<b>ê¶Œì¥ ì¹¼ë¡œë¦¬: {tdee:.0f} kcal</b>"
    render()
calc_btn.on_click(on_calc_clicked)

# ê²€ìƒ‰/ì„ íƒ/ì¶”ê°€
food_search = W.Text(description="ìŒì‹ ê²€ìƒ‰", placeholder="ì˜ˆ) ë‹­ê°€ìŠ´ì‚´, ë¼ë©´, ìš°ìœ  â€¦")
search_btn = W.Button(description="ê²€ìƒ‰", button_style="info", icon="search"); search_btn.disabled = True
search_results= W.Select(options=[], rows=8, description="ê²€ìƒ‰ê²°ê³¼"); search_results.disabled = True
kcal_info = W.HTML("")
amount = W.FloatText(description="ì–‘", value=200.0)
amount_unit = W.Dropdown(description="ë‹¨ìœ„", options=["g","ml"], value="g")
meal_cat = W.Dropdown(options=["ì•„ì¹¨","ì ì‹¬","ì €ë…","ê°„ì‹"], description="êµ¬ë¶„")
add_btn = W.Button(description="ì„­ì·¨ ì¶”ê°€", button_style="success")
add_out = W.HTML("")

# AI ì¹´ë“œ
recommend_out = W.HTML("")
protein_out   = W.HTML("")

# ì¶”ì²œ ë¡œì§
def get_recommendation(food_name, food_unit, db):
    original = db[(db["ì‹í’ˆëª…"] == food_name) & (db["base_unit"] == food_unit)]
    if original.empty:
        return "<span style='color:#888'>ì„ íƒ í•­ëª©ì„ DBì—ì„œ ì°¾ì§€ ëª»í–ˆì–´ìš”.</span>"
    orig_kcal = float(original.iloc[0]["per100"])
    orig_co2  = float(original.iloc[0]["carbon_per100_gCO2"])
    candidates = db[(db["per100"] < orig_kcal) & (db["carbon_per100_gCO2"] < orig_co2)].copy()
    if candidates.empty:
        return "<span style='color:#888'>ğŸ’¡ ë” ë‚˜ì€ ëŒ€ì•ˆì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.</span>"
    candidates["score"] = (orig_kcal - candidates["per100"]) + 10.0*(orig_co2 - candidates["carbon_per100_gCO2"])
    top = candidates.sort_values(["score","per100","carbon_per100_gCO2"], ascending=[False,True,True]).head(3)
    best = top.iloc[0]
    kcal_reduc_pct = max(0.0, 100.0 * (orig_kcal - best["per100"]) / max(1e-6, orig_kcal))
    co2_reduc_pct  = max(0.0, 100.0 * (orig_co2  - best["carbon_per100_gCO2"]) / max(1e-6, orig_co2))
    alt = f" ëŒ€ì•ˆ: {top.iloc[1]['ì‹í’ˆëª…']}" if len(top) >= 2 else ""
    return (f"ğŸ’¡ <b>AI ì¶”ì²œ</b> â€” <b>{best['ì‹í’ˆëª…']}</b> ì–´ë– ì„¸ìš”? "
            f"ì¹¼ë¡œë¦¬ <b>{kcal_reduc_pct:.0f}%â†“</b>, íƒ„ì†Œ <b>{co2_reduc_pct:.0f}%â†“</b> ê°€ëŠ¥í•´ìš”."
            f"<span style='color:#666'>{alt}</span>")

# ì„ íƒí˜•: ë‹¨ë°±ì§ˆ íŒíŠ¸
def protein_hint(weight_kg, log_df):
    if "protein_g" not in log_df.columns or log_df["protein_g"].isna().all():
        return "<span style='color:#888'>ë‹¨ë°±ì§ˆ ì •ë³´ë¥¼ ì¶”ì •í•  ë°ì´í„°ê°€ ì—†ì–´ìš”.</span>"
    today = log_df[log_df["date"] == TODAY_TS]
    target = 1.6 * float(weight_kg)
    cur = float(today["protein_g"].sum())
    if cur < 0.6 * target: msg = "ì˜¤ëŠ˜ ë‹¨ë°±ì§ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤."
    elif cur < target:     msg = "ì¡°ê¸ˆë§Œ ë” ì„­ì·¨í•˜ë©´ ëª©í‘œì— ë„ë‹¬í•´ìš”."
    else:                  msg = "ì˜¤ëŠ˜ ë‹¨ë°±ì§ˆ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆì–´ìš”!"
    return f"ğŸ— {msg} ({cur:.0f}g / ëª©í‘œ {target:.0f}g)"

# ê²€ìƒ‰
def run_search(_=None):
    global FOOD_DB
    if FOOD_DB is None or not isinstance(FOOD_DB, pd.DataFrame) or FOOD_DB.empty:
        kcal_info.value = "<span style='color:red'>ë¨¼ì € ìœ„ì—ì„œ ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</span>"
        search_results.options = []; return
    q = food_search.value.strip()
    if not q:
        search_results.options = []; kcal_info.value = ""; return
    mask = FOOD_DB["ì‹í’ˆëª…"].str.contains(re.escape(q), case=False, na=False)
    result = FOOD_DB.loc[mask, ["ì‹í’ˆëª…","base_unit","per100"]].copy()
    result["label"] = result["ì‹í’ˆëª…"] + " (" + result["base_unit"] + ") â€” " + result["per100"].round(1).astype(str) + " kcal/100"
    search_results.options = list(result["label"]) if not result.empty else ["(ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ)"]
    kcal_info.value = ""
search_btn.on_click(run_search)
food_search.observe(lambda _ : run_search(), names="value")

# ì„ íƒ ë³€ê²½
def on_select_change(change):
    global FOOD_DB, LOG
    if FOOD_DB is None or not isinstance(FOOD_DB, pd.DataFrame) or FOOD_DB.empty:
        kcal_info.value = "<span style='color:red'>ë¨¼ì € ìŒì‹DBë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</span>"
        recommend_out.value = ""; protein_out.value = ""; return
    sel = change["new"] or ""
    if not sel or sel.startswith("("):
        kcal_info.value = ""; recommend_out.value = ""; protein_out.value = ""; return
    m = re.match(r'(.+?) \((g|ml)\)\sâ€”\s', sel)
    if not m:
        kcal_info.value = ""; recommend_out.value = ""; protein_out.value = ""; return
    name, unit = m.group(1), m.group(2)

    row_sel = FOOD_DB[(FOOD_DB["ì‹í’ˆëª…"] == name) & (FOOD_DB["base_unit"] == unit)]
    if row_sel.empty:
        kcal_info.value = "<span style='color:red'>ì„ íƒ í•­ëª©ì„ DBì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>"
        recommend_out.value = ""; protein_out.value = ""; return

    r = row_sel.iloc[0]
    per100 = float(r["per100"])
    
    # ì˜ì–‘ ì •ë³´ í…ìŠ¤íŠ¸
    nutri_info = []
    if "carb_per100" in r and pd.notna(r["carb_per100"]): nutri_info.append(f"íƒ„ìˆ˜í™”ë¬¼ {r['carb_per100']:.1f}g")
    if "protein_per100" in r and pd.notna(r["protein_per100"]): nutri_info.append(f"ë‹¨ë°±ì§ˆ {r['protein_per100']:.1f}g")
    if "fat_per100" in r and pd.notna(r["fat_per100"]): nutri_info.append(f"ì§€ë°© {r['fat_per100']:.1f}g")
    
    kcal_info.value = (f"<span style='color:#666'>ì„ íƒ: <b>{name}</b> [{unit}] â€” {per100:.1f} kcal / 100{unit}<br>"
                       f"â”” {', '.join(nutri_info)}</span>")
    amount_unit.value = unit

    # ì¶”ì²œ ì¹´ë“œ
    recommendation_text = get_recommendation(name, unit, FOOD_DB)
    recommend_out.value = (
        "<div style='margin-top:8px;padding:10px;border-radius:8px;"
        "background:#F1F8FF;border:1px solid #D6E8FF'>"
        f"{recommendation_text}"
        "</div>"
    )
    # ë‹¨ë°±ì§ˆ ì¹´ë“œ
    protein_text = protein_hint(weight.value, LOG)
    protein_out.value = (
        "<div style='margin-top:8px;padding:10px;border-radius:8px;"
        "background:#F7FBF2;border:1px solid #DDEFD3'>"
        f"{protein_text}"
        "</div>"
    )
search_results.observe(on_select_change, names="value")

# [ìˆ˜ì •ë¨] ê¸°ë¡ LOG: íƒ„/ë‹¨/ì§€ ì»¬ëŸ¼ ì¶”ê°€
LOG = pd.DataFrame(columns=[
    "date", "category", "food", "amount", "unit",
    "kcal", "co2_g", "protein_g", "fat_g", "carb_g"
])

def add_entry(_=None):
    global LOG, FOOD_DB
    if FOOD_DB is None or not isinstance(FOOD_DB, pd.DataFrame) or FOOD_DB.empty:
        add_out.value = "<span style='color:red'>ë¨¼ì € ìœ„ì—ì„œ ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</span>"; return
    sel = search_results.value if search_results.value else ""
    m = re.match(r'(.+?) \((g|ml)\)\sâ€”\s', sel or "")
    if not m:
        add_out.value = "<span style='color:red'>ê²€ìƒ‰ í›„ ê²°ê³¼ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</span>"; return
    name, base_unit = m.group(1), m.group(2)

    row_sel = FOOD_DB[(FOOD_DB["ì‹í’ˆëª…"] == name) & (FOOD_DB["base_unit"] == base_unit)]
    if row_sel.empty:
        add_out.value = "<span style='color:red'>ì„ íƒ í•­ëª©ì„ DBì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>"; return

    r = row_sel.iloc[0]
    
    # [ìˆ˜ì •ë¨] ì„­ì·¨ëŸ‰ ê³„ì‚° ì‹œ íƒ„/ë‹¨/ì§€ í¬í•¨
    amt = float(amount.value)
    multiplier = amt / 100.0
    
    kcal = (r["kcal_per1"] * 100) * multiplier
    co2g = r["carbon_per100_gCO2"] * multiplier
    
    protein_g = r.get("protein_per100", 0) * multiplier
    fat_g = r.get("fat_per100", 0) * multiplier
    carb_g = r.get("carb_per100", 0) * multiplier

    new_row = {
        "date": TODAY_TS, "category": meal_cat.value, "food": name,
        "amount": round(amt,1), "unit": amount_unit.value,
        "kcal": round(kcal,1), "co2_g": round(co2g,1),
        "protein_g": round(protein_g, 1),
        "fat_g": round(fat_g, 1),
        "carb_g": round(carb_g, 1)
    }

    LOG = pd.concat([LOG, pd.DataFrame([new_row])], ignore_index=True)
    add_out.value = (f"<span style='color:green'>ì¶”ê°€ë¨: <b>{name}</b> {amt}{amount_unit.value} â†’ "
                     f"{kcal:.0f} kcal, {co2g:.1f} g COâ‚‚ ({meal_cat.value})</span>")
    render()
add_btn.on_click(add_entry)

# CSV ì €ì¥
download_btn = W.Button(description="CSV ë‹¤ìš´ë¡œë“œ(ì˜¤ëŠ˜)")
def download_csv(_):
    if LOG.empty:
        with status_out: clear_output(); print("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return
    fname = "ì„­ì·¨ê¸°ë¡_ì˜¤ëŠ˜.csv"
    LOG[LOG["date"] == TODAY_TS].sort_values("category").to_csv(fname, index=False)
    files.download(fname)
download_btn.on_click(download_csv)

status_out = W.Output()
summary_box= W.HTML("")
table_out  = W.Output()

# [ìˆ˜ì •ë¨] render í•¨ìˆ˜: ìš”ì•½ ë° í‘œì— íƒ„/ë‹¨/ì§€ ì •ë³´ ì¶”ê°€
def render():
    today_log = LOG[LOG["date"] == TODAY_TS].copy()
    
    if today_log.empty:
        total_kcal, total_co2g = 0.0, 0.0
        total_carb, total_prot, total_fat = 0.0, 0.0, 0.0
    else:
        total_kcal = float(today_log["kcal"].sum())
        total_co2g = float(today_log["co2_g"].sum())
        total_carb = float(today_log["carb_g"].sum())
        total_prot = float(today_log["protein_g"].sum())
        total_fat  = float(today_log["fat_g"].sum())

    try:
        goal = float(re.sub(r"[^0-9\.]", "", tdee_out.value)) or 2000.0
    except Exception:
        goal = 2000.0
    pct = 0.0 if goal <= 0 else round(100.0 * total_kcal / goal, 1)
    
    # [ìˆ˜ì •ë¨] ìš”ì•½ ë°•ìŠ¤ HTML
    summary_box.value = f"""
    <div style="display:flex;gap:16px;flex-wrap:wrap">
        <div style="flex:1 1 260px;border:1px solid #eee;border-radius:8px;padding:12px;">
            <div style="font-size:13px;color:#666">ê¶Œì¥ ì¹¼ë¡œë¦¬(TDEE)</div>
            <div style="font-size:20px;font-weight:700">{goal:.0f} kcal</div>
        </div>
        <div style="flex:1 1 260px;border:1px solid #eee;border-radius:8px;padding:12px;">
            <div style="font-size:13px;color:#666">ì˜¤ëŠ˜ ì„­ì·¨ ì¹¼ë¡œë¦¬(ëˆ„ì )</div>
            <div style="font-size:20px;font-weight:700">{total_kcal:.0f} kcal
                <span style="font-size:12px;color:#888">({pct}% of TDEE)</span>
            </div>
        </div>
        <div style="flex:1 1 260px;border:1px solid #eee;border-radius:8px;padding:12px;">
            <div style="font-size:13px;color:#666">ì˜¤ëŠ˜ íƒ„ì†Œë°°ì¶œëŸ‰(ëˆ„ì )</div>
            <div style="font-size:20px;font-weight:700">{(total_co2g/1000):.3f} kg COâ‚‚e</div>
        </div>
    </div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:10px;">
        <div style="flex:1 1 260px;border:1px solid #eee;border-radius:8px;padding:12px;background-color:#F2F8FF;">
            <div style="font-size:13px;color:#666">ì´ íƒ„ìˆ˜í™”ë¬¼</div>
            <div style="font-size:20px;font-weight:700">{total_carb:.1f} g</div>
        </div>
        <div style="flex:1 1 260px;border:1px solid #eee;border-radius:8px;padding:12px;background-color:#F0FFF0;">
            <div style="font-size:13px;color:#666">ì´ ë‹¨ë°±ì§ˆ</div>
            <div style="font-size:20px;font-weight:700">{total_prot:.1f} g</div>
        </div>
        <div style="flex:1 1 260px;border:1px solid #eee;border-radius:8px;padding:12px;background-color:#FFF8E1;">
            <div style="font-size:13px;color:#666">ì´ ì§€ë°©</div>
            <div style="font-size:20px;font-weight:700">{total_fat:.1f} g</div>
        </div>
    </div>
    """
    
    with table_out:
        clear_output(wait=True)
        if today_log.empty:
            print("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            # [ìˆ˜ì •ë¨] í…Œì´ë¸” ì»¬ëŸ¼ëª… ë° ìˆœì„œ
            tbl = today_log.rename(columns={
                "category":"êµ¬ë¶„", "food":"ì‹í’ˆ", "amount":"ì–‘", "unit":"ë‹¨ìœ„",
                "co2_g":"COâ‚‚(g)", "carb_g":"íƒ„ìˆ˜í™”ë¬¼(g)", "protein_g":"ë‹¨ë°±ì§ˆ(g)", "fat_g":"ì§€ë°©(g)"
            })
            tbl["kcal"] = tbl["kcal"].round(0).astype(int)
            
            # ëª¨ë“  ì˜ì–‘ì„±ë¶„ ì»¬ëŸ¼ì„ ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
            for col in ["COâ‚‚(g)", "íƒ„ìˆ˜í™”ë¬¼(g)", "ë‹¨ë°±ì§ˆ(g)", "ì§€ë°©(g)"]:
                if col in tbl.columns:
                    tbl[col] = tbl[col].round(1)

            display_cols = ["êµ¬ë¶„", "ì‹í’ˆ", "ì–‘", "ë‹¨ìœ„", "kcal", "íƒ„ìˆ˜í™”ë¬¼(g)", "ë‹¨ë°±ì§ˆ(g)", "ì§€ë°©(g)", "COâ‚‚(g)"]
            
            # DBì— ì˜ì–‘ì„±ë¶„ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´, ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ ì„ íƒ
            final_cols = [col for col in display_cols if col in tbl.columns]
            
            display(tbl[final_cols].reset_index(drop=True))

    with status_out:
        clear_output(wait=True); print("âœ… ì˜¤ëŠ˜ ê¸°ì¤€ ìš”ì•½ ê°±ì‹  ì™„ë£Œ")


# UI
ui = W.VBox([
    W.HTML("<h2>íŒ€ì› B/C â€” í•˜ë£¨ ìš”ì•½ ë° AI ì¶”ì²œ ëŒ€ì‹œë³´ë“œ</h2>"),
    W.HTML("â€¢ ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜, ê°™ì€ í´ë”ì— 3ê°œ íŒŒì¼ì„ ë‘ê³  'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”.<br>â€¢ <b>(Update)</b> íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°© ì •ë³´ê°€ ìš”ì•½ ë° ì„­ì·¨ ë‚´ì—­ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."),
    W.HBox([uploader, load_btn]), load_out,
    W.HTML("<hr>"),
    W.HTML("<b>â‘  ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°</b>"),
    W.HBox([age, sex]), W.HBox([height, weight]), activity, W.HBox([calc_btn, tdee_out]),
    W.HTML("<hr>"),
    W.HTML("<b>â‘¡ ìŒì‹ ê²€ìƒ‰/ì¶”ê°€ (ì—‘ì…€ DB ê¸°ë°˜)</b>"),
    W.HBox([food_search, search_btn]),
    W.HBox([search_results, kcal_info], layout=W.Layout(align_items='center')),
    W.HBox([amount, amount_unit, meal_cat, add_btn]), add_out,
    W.HTML("<hr>"),
    W.HTML("<b>â‘¢ AI ìŒì‹ ì¶”ì²œ</b>"),
    recommend_out,
    protein_out,
    W.HTML("<hr>"),
    W.HTML("<b>â‘£ ì˜¤ëŠ˜ ìš”ì•½</b>"),
    summary_box,
    W.HTML("<b>â‘¤ ì˜¤ëŠ˜ ì„­ì·¨ ë‚´ì—­</b>"),
    table_out,
    W.HBox([download_btn]),
    status_out
])

display(ui)
render()
