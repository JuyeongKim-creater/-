# ===================== Colab: 2025-08 ì‹ë‹¨ ë‹¬ë ¥ (xls ì—ëŸ¬ ê³ ì •, ì œì™¸ëª©ë¡ ë°˜ì˜, 2000~2500 kcal) =====================
import sys, subprocess, importlib, os, io, re, calendar, random
from datetime import date
from IPython.display import display, HTML

# -------- 0) .xls ì§€ì› í™˜ê²½ í™•ì •: pandas==1.5.3 + xlrd==1.2.0 --------
def ensure_legacy_xls_support():
    """
    - pandas 2.x ëŠ” xlrd 2.xë¥¼ ìš”êµ¬í•˜ì§€ë§Œ .xlsëŠ” ì§€ì›í•˜ì§€ ì•ŠìŒ
    - Colabì—ì„œ .xlsë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì½ê¸° ìœ„í•´ pandas==1.5.3 + xlrd==1.2.0 ê³ ì •
    """
    need_fix = False
    try:
        import pandas as pd
        pv_major = int(pd.__version__.split(".")[0])
        if pv_major >= 2:
            need_fix = True
    except Exception:
        need_fix = True

    try:
        import xlrd
        xv_major = int(xlrd.__version__.split(".")[0])
        if xv_major >= 2:  # 2.xëŠ” .xls ë¯¸ì§€ì›
            need_fix = True
    except Exception:
        need_fix = True

    if need_fix:
        print("ğŸ”§ .xls ì§€ì›ì„ ìœ„í•´ pandas==1.5.3, xlrd==1.2.0ìœ¼ë¡œ ì¬ì„¤ì¹˜í•©ë‹ˆë‹¤...")
        subprocess.run([sys.executable, "-m", "pip", "uninstall", "-y", "pandas", "xlrd"], check=False)
        subprocess.run([sys.executable, "-m", "pip", "install", "--no-cache-dir",
                        "pandas==1.5.3", "xlrd==1.2.0", "openpyxl", "numpy", "ipywidgets"], check=True)
        importlib.invalidate_caches()
        print("âœ… ì„¤ì¹˜ ì •ë¹„ ì™„ë£Œ.")

ensure_legacy_xls_support()

import numpy as np
import pandas as pd
from google.colab import files

# -------- 1) ì‚¬ìš©ì ì—…ë¡œë“œ(ì„ íƒ) + ê¸°ë³¸ ê²½ë¡œ --------
print("ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë ¤ë©´ íŒì—…ì—ì„œ 'ì›ì¬ë£Œ.xls / ê°€ê³µì‹í’ˆ.xlsx / ìš”ë¦¬.xlsx'ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ê±´ë„ˆë›°ë©´ /mnt/data íŒŒì¼ ì‚¬ìš©)")
try:
    uploaded = files.upload()  # ì—…ë¡œë“œëŠ” ì„ íƒ ì‚¬í•­
    UP_FILES = list(uploaded.keys())
except Exception:
    UP_FILES = []

DEFAULT_FILES = [
    "/mnt/data/ì›ì¬ë£Œ.xls",
    "/mnt/data/ê°€ê³µì‹í’ˆ.xlsx",
    "/mnt/data/ìš”ë¦¬.xlsx",
    # ì—¬ë¶„(í•œê¸€ ì¡°í•© ì´ìŠˆ ëŒ€ë¹„)
    "/mnt/data/á„‹á…¯á†«á„Œá…¢á„…á…­.xls",
    "/mnt/data/á„€á…¡á„€á…©á†¼á„‰á…µá†¨á„‘á…®á†·.xlsx",
    "/mnt/data/á„‹á…­á„…á…µ.xlsx",
]

def _read_excel_any(local_path: str) -> pd.DataFrame:
    """
    í™•ì¥ìë³„ ì—”ì§„ì„ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ , ì‹¤íŒ¨ ì‹œ ì—”ì§„ ìë™ ì¬ì‹œë„.
    """
    ext = os.path.splitext(local_path)[1].lower()
    try:
        if ext == ".xls":
            xls = pd.ExcelFile(local_path, engine="xlrd")
            return pd.read_excel(xls, sheet_name=xls.sheet_names[0], engine="xlrd")
        else:  # .xlsx
            xls = pd.ExcelFile(local_path, engine="openpyxl")
            return pd.read_excel(xls, sheet_name=xls.sheet_names[0], engine="openpyxl")
    except Exception as e1:
        try:
            xls = pd.ExcelFile(local_path)
            return pd.read_excel(xls, sheet_name=xls.sheet_names[0])
        except Exception as e2:
            raise RuntimeError(f"íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {local_path}\n - 1ì°¨:{e1}\n - 2ì°¨:{e2}")

def load_sources() -> pd.DataFrame:
    dfs = []
    # 1) ì—…ë¡œë“œ ìš°ì„ 
    for p in UP_FILES:
        try:
            df = _read_excel_any(p)
            df.columns = [str(c).strip() for c in df.columns]
            if not df.empty: dfs.append(df)
            else: print(f"âš  ë¹ˆ ì‹œíŠ¸ ê±´ë„ˆëœ€: {p}")
        except Exception as e:
            print(f"âš  íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {p} -> {e}")
    # 2) ê¸°ë³¸ ê²½ë¡œ
    if not dfs:
        for p in DEFAULT_FILES:
            if os.path.exists(p):
                try:
                    df = _read_excel_any(p)
                    df.columns = [str(c).strip() for c in df.columns]
                    if not df.empty: dfs.append(df)
                    else: print(f"âš  ë¹ˆ ì‹œíŠ¸ ê±´ëˆ„ëœ€: {p}")
                except Exception as e:
                    print(f"âš  íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {p} -> {e}")
    if not dfs:
        raise RuntimeError("ì—‘ì…€ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. /mnt/data ê²½ë¡œì— 'ì›ì¬ë£Œ.xls, ê°€ê³µì‹í’ˆ.xlsx, ìš”ë¦¬.xlsx' ì¤‘ í•˜ë‚˜ ì´ìƒì„ ë‘ê±°ë‚˜ ì—…ë¡œë“œí•˜ì„¸ìš”.")
    return pd.concat(dfs, ignore_index=True, sort=False)

# -------- 2) í‘œì¤€í™”(ì‹í’ˆëª…/ë‹¨ìœ„/kcal) --------
def normalize_food_table(df_raw: pd.DataFrame) -> pd.DataFrame:
    """
    ê²°ê³¼ ì»¬ëŸ¼: ì‹í’ˆëª…, base_unit(g/ml), kcal_per1, per100, is_dish
    """
    df = df_raw.copy()
    df.columns = [str(c).strip() for c in df.columns]

    name_col = next((c for c in df.columns if any(k in c for k in ["ì‹í’ˆëª…","ì œí’ˆëª…","í’ˆëª…","ë©”ë‰´","food","name"])), None)
    unit_col = next((c for c in df.columns if any(k in c for k in ["ì˜ì–‘ì„±ë¶„í•¨ëŸ‰ê¸°ì¤€ëŸ‰","ê¸°ì¤€","ë‹¨ìœ„","1íšŒì œê³µëŸ‰","serving"])), None)
    kcal_col = next((c for c in df.columns if ("kcal" in c.lower()) or ("ì—´ëŸ‰" in c)), None)

    # ìµœì†Œ ë³´ì •
    if name_col is None: name_col = df.columns[0]
    if unit_col is None: unit_col = df.columns[1] if len(df.columns) > 1 else df.columns[0]
    if kcal_col is None:
        num_cols = [c for c in df.columns if pd.api.types.is_numeric_dtype(df[c])]
        if num_cols: kcal_col = num_cols[0]
        else: raise ValueError(f"í•„ìš” ì—´(ì‹í’ˆëª…/ë‹¨ìœ„/kcal) ì¶”ì¶œ ì‹¤íŒ¨. í˜„ì¬ ì—´: {list(df.columns)[:10]} ...")

    def parse_unit(s):
        s = "" if pd.isna(s) else str(s)
        m = re.search(r'([\d\.]+)\s*(g|ml|mL|G|ML)', s)
        if m:
            amt = float(m.group(1))
            unit = "ml" if "ml" in m.group(2).lower() else "g"
            return amt, unit
        m2 = re.search(r'1\s*íšŒ.*?([\d\.]+)\s*(g|ml)', s)
        if m2:
            return float(m2.group(1)), m2.group(2).lower()
        return 100.0, "g"

    parsed = df[unit_col].apply(parse_unit)
    df["base_amount"] = parsed.apply(lambda x: x[0])
    df["base_unit"]   = parsed.apply(lambda x: x[1])
    df["kcal_per1"]   = pd.to_numeric(df[kcal_col], errors="coerce") / df["base_amount"]

    out = df[[name_col, "base_unit", "kcal_per1"]].rename(columns={name_col:"ì‹í’ˆëª…"})
    out = out.dropna(subset=["ì‹í’ˆëª…","kcal_per1"])
    out = out.groupby(["ì‹í’ˆëª…","base_unit"], as_index=False)["kcal_per1"].mean()
    out["per100"] = (out["kcal_per1"] * 100).round(1)

    # 'í•œ ë¼ ìŒì‹' ìš°ì„  ì„ ì •ì„ ìœ„í•œ í‚¤ì›Œë“œ
    dish_kw = ["êµ­","íƒ•","ì°Œê°œ","ë®ë°¥","ë³¶ìŒë°¥","ë¹„ë¹”ë°¥","íŒŒìŠ¤íƒ€","ë¼ë©´","ìš°ë™","ì¹¼êµ­ìˆ˜","ëƒ‰ë©´","ì§œì¥","ì§¬ë½•",
               "ë¹„ë¹”êµ­ìˆ˜","êµ­ìˆ˜","ë§Œë‘","ëˆê¹ŒìŠ¤","ì¹´ë ˆ","ë¦¬ì¡°ë˜","ê¹€ì¹˜ë³¶ìŒë°¥","ê¹€ë°¥","ë¶€ëŒ€ì°Œê°œ","ì„¤ë íƒ•","ìˆœëŒ“êµ­",
               "ê°ìíƒ•","ì‚¼ê³„íƒ•","ê°ˆë¹„íƒ•","ê°ˆë¹„ì°œ","ì°œ","ì°œë‹­","ì œìœ¡ë³¶ìŒ","ì¹˜í‚¨","ë²„ê±°","í”¼ì","ìŠ¤í…Œì´í¬","ìƒëŸ¬ë“œ"]
    out["is_dish"] = out["ì‹í’ˆëª…"].astype(str).apply(lambda x: any(k in x for k in dish_kw))
    return out.reset_index(drop=True)

# -------- 3) ì œì™¸í•  ì‹í’ˆ(ìš”ì²­ ëª©ë¡) --------
EXCLUDE_NAMES = [
    "SJëª¨ì§œë ë¼í”¼ìì¹˜ì¦ˆ", "êµ­ë‚´ì‚°ë°€ê°€ë£¨ë¡œë§Œë“ ë˜ë ì•„", "ìœ ê¸°ë†í™©ì„¤íƒ•",
    "í”¼ì_ì‚´ì¹˜ìŠ¤í…Œì´í¬ í”¼ì ë°€ë„ìš° (R)", "í•œë§ˆìŒ ëƒ‰ë©´ìœ¡ìˆ˜", "ì‹œë¯¼ëƒ‰ë©´ ìƒë©´",
    "ë¶ ìŠ¤ìœ— í”¼ìì¹˜ì¦ˆ", "êµ­ë°¥ìš© ìˆ˜ìœ¡", "JL í”¼ìì¹˜ì¦ˆ",
    "ì¢…ë¡œë©´ì„ ìƒë“¤ê¹¨ì¹¼êµ­ìˆ˜ë©´", "ë°€ì–¸ë‹ˆì˜ ê·€ë¦¬ íŒŒìŠ¤íƒ€ë©´", "ì‚°íƒ€ì†œì‚¬íƒ•-í™”ì´íŠ¸"
]
def apply_exclusion(pool: pd.DataFrame) -> pd.DataFrame:
    names = set(n.lower() for n in EXCLUDE_NAMES)
    def banned(x):
        xx = str(x).lower()
        # ì •í™•ë„ ë†’ì´ê¸°: ì™„ì „ì¼ì¹˜ or í¬í•¨(ë‘˜ ë‹¤ ê±¸ëŸ¬ëƒ„)
        return any(xx == n or n in xx for n in names)
    return pool[~pool["ì‹í’ˆëª…"].astype(str).apply(banned)].reset_index(drop=True)

# -------- 4) 1ì‹ 1ë©”ë‰´ ìƒì„±(2000~2500kcal ëª©í‘œ ì¶©ì¡±) --------
def _pick_one_dish(pool: pd.DataFrame, rng: random.Random, kcal_target: float):
    cand = pool[(pool["per100"] > 0) & (pool["per100"] < 900)].copy()
    if cand.empty: return None
    dish = cand[cand["is_dish"]]
    use = dish if not dish.empty else cand

    row = use.sample(1, random_state=rng.randint(1, 10**9)).iloc[0]
    name = str(row["ì‹í’ˆëª…"]); unit = row["base_unit"]
    per1 = float(row["kcal_per1"])  # 1 g/ml ë‹¹ kcal
    if per1 <= 0 or np.isnan(per1): return None

    amt = kcal_target / per1
    if unit == "g":   amt = float(np.clip(amt, 200, 700))
    else:             amt = float(np.clip(amt, 300, 1200))
    amt *= rng.uniform(0.9, 1.1)

    kcal = per1 * amt
    return (name, round(amt), unit, round(kcal, 0))

def build_day_meals(pool: pd.DataFrame, rng: random.Random):
    for _ in range(12):
        t_break = rng.uniform(600, 750)
        t_lunch = rng.uniform(750, 900)
        t_din   = rng.uniform(750, 900)

        b = _pick_one_dish(pool, rng, t_break)
        l = _pick_one_dish(pool, rng, t_lunch)
        d = _pick_one_dish(pool, rng, t_din)
        if any(x is None for x in [b, l, d]):  # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì¬ì‹œë„
            continue
        total = b[3] + l[3] + d[3]
        if 2000 <= total <= 2500:
            return {"ì•„ì¹¨":[b], "ì ì‹¬":[l], "ì €ë…":[d]}, total

    # ê·¼ì‚¬ì¹˜ë¼ë„ ë°˜í™˜
    b = _pick_one_dish(pool, rng, 700)
    l = _pick_one_dish(pool, rng, 850)
    d = _pick_one_dish(pool, rng, 850)
    if any(x is None for x in [b, l, d]):
        return {"ì•„ì¹¨":[], "ì ì‹¬":[], "ì €ë…":[]}, 0.0
    return {"ì•„ì¹¨":[b], "ì ì‹¬":[l], "ì €ë…":[d]}, (b[3]+l[3]+d[3])

# -------- 5) ë‹¬ë ¥ ìƒì„± + í‘œê¸° --------
def make_meal_calendar(year:int, month:int, seed:int=123, show=True):
    raw = load_sources()
    FOOD = normalize_food_table(raw)
    FOOD = apply_exclusion(FOOD)  # ğŸ”´ ìš”ì²­ ì œì™¸ ëª©ë¡ ë°˜ì˜

    rng = random.Random(seed)
    last_day = calendar.monthrange(year, month)[1]
    days = [date(year, month, d) for d in range(1, last_day+1)]

    plans = {}; rows = []
    for d in days:
        meals, total = build_day_meals(FOOD, rng)
        b = int(sum(x[3] for x in meals["ì•„ì¹¨"]))
        l = int(sum(x[3] for x in meals["ì ì‹¬"]))
        dn = int(sum(x[3] for x in meals["ì €ë…"]))
        plans[d] = meals
        rows.append({"date": pd.Timestamp(d),
                     "kcal_total": int(total),
                     "kcal_breakfast": b,
                     "kcal_lunch": l,
                     "kcal_dinner": dn})
    df_month = pd.DataFrame(rows)

    # ì›” ë‹¬ë ¥ HTML
    cgrid = calendar.monthcalendar(year, month)
    wk_names = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "]
    month_name = f"{year}ë…„ {month}ì›”"

    def cell_html(day_num):
        if day_num == 0:
            return "<td></td>"
        d = pd.Timestamp(date(year, month, day_num))
        row = df_month[df_month["date"]==d].iloc[0]
        top = int(row["kcal_total"])
        b = int(row["kcal_breakfast"]); l = int(row["kcal_lunch"]); dn = int(row["kcal_dinner"])
        # ì´ kcal í¬ê²Œ, ì•„ë˜ ì¤„ ì•„ì¹¨/ì ì‹¬/ì €ë… kcal
        return f"""
        <td style="vertical-align:top; width:120px; height:92px; padding:8px;">
          <div style="font-weight:600; margin-bottom:4px;">{day_num}</div>
          <div style="font-size:18px; font-weight:700;">{top}</div>
          <div style="color:#666; font-size:12px;">{b}/{l}/{dn}</div>
        </td>"""

    html = f"""
    <div style="font-size:20px; font-weight:700; margin:8px 0;">ë‹¬ë ¥</div>
    <div style="font-size:16px; margin-bottom:6px;">{month_name}</div>
    <table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
      <thead><tr>{"".join(f'<th style="width:120px; padding:6px; color:#666;">{w}</th>' for w in wk_names)}</tr></thead>
      <tbody>
    """
    for week in cgrid:
        html += "<tr>" + "".join(cell_html(dn) for dn in week) + "</tr>"
    html += "</tbody></table>"

    if show: display(HTML(html))
    return df_month, plans, html

# ===================== ì‹¤í–‰: 2025ë…„ 8ì›” (1~31ì¼ ë‹¬ë ¥ + ìƒì„¸ ìë™ë©”ë‰´) =====================
df_aug, plans_aug, cal_html = make_meal_calendar(2025, 8, seed=777, show=True)

# ëª¨ë“  ë‚ ì§œì˜ ìë™ êµ¬ì„± ë©”ë‰´(ë©”ë‰´ëª…Â·ì–‘Â·kcal) ì „ì²´ ì¶œë ¥
def show_month_details(plans_dict, y, m):
    last_day = calendar.monthrange(y, m)[1]
    for d in range(1, last_day+1):
        k = date(y, m, d)
        meals = plans_dict.get(k, {})
        print(f"\n[{y}-{m:02d}-{d:02d}] ìë™ êµ¬ì„± ë©”ë‰´")
        for meal in ["ì•„ì¹¨","ì ì‹¬","ì €ë…"]:
            items = meals.get(meal, [])
            line = " + ".join([f"{nm} {amt}{u}({int(kc)}kcal)" for nm,amt,u,kc in items]) or "-"
            print(f"  Â· {meal}: {line}")

show_month_details(plans_aug, 2025, 8)
