# 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (Colab ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰)
!pip install ipywidgets pandas numpy openpyxl xlrd==2.0.1 --quiet

# 2. ì„í¬íŠ¸
import pandas as pd
import numpy as np
import ipywidgets as widgets
from IPython.display import display, clear_output
from itertools import product
import io
import random

# 3. íƒ„ì†Œë°°ì¶œëŸ‰ DB êµ¬ì„±
EMISSION_FACTORS = {
    "1. ë†ì¥": {
        "ì†Œê³ ê¸°": 48.0, "ë¼ì§€ê³ ê¸°": 5.5, "ë‹­ê³ ê¸°": 4.8,
        "ê³„ë€": 2.5, "ìœ ì œí’ˆ": 2.0, "ìŒ€": 3.0, "ê³¼ì¼": 0.4,
        "ì±„ì†Œ": 0.2, "ìˆ˜ì‚°ë¬¼(ì–‘ì‹)": 3.5, "ìˆ˜ì‚°ë¬¼(ìì—°ì‚°)": 1.5
    },
    "2. ê³µì¥": {"ê°€ê³µ": 0.4, "ì‚´ê· /ë©¸ê· ": 0.3, "í¬ì¥": 0.2},
    "3. ìœ í†µ": {"êµ­ì‚°": 0.1, "í•´ìƒìš´ì†¡": 2.0, "í•­ê³µìš´ì†¡": 25.0},
    "4. ë§¤ì¥": {"ëƒ‰ì¥/ëƒ‰ë™": 0.2, "ì¡°ëª… ë° ê¸°íƒ€ ì—ë„ˆì§€": 0.1, "ì‹í’ˆ íê¸°": 0.2},
}

def get_carbon_tags(food_name):
    tags = []
    for stage, items in EMISSION_FACTORS.items():
        for tag in items:
            if tag in str(food_name):
                tags.append((stage, tag))
    if not any("ìœ í†µ" in stage for stage, _ in tags):
        tags.append(("3. ìœ í†µ", "êµ­ì‚°"))
    return tags

def calculate_carbon_factor(tags):
    return sum(EMISSION_FACTORS[stage].get(tag, 0) for stage, tag in tags)

# 4. ì‚¬ìš©ì ê¶Œì¥ ì„­ì·¨ëŸ‰ ê³„ì‚°
def calculate_user_targets(gender, age, height, weight, activity_level='ë³´í†µ'):
    if gender == 'ë‚¨ì„±':
        bmr = 10 * weight + 6.25 * height - 5 * age + 5
    else:
        bmr = 10 * weight + 6.25 * height - 5 * age - 161
    factors = {'ë‚®ìŒ': 1.375, 'ë³´í†µ': 1.55, 'ë†’ìŒ': 1.725}
    tdee = bmr * factors.get(activity_level, 1.55)
    return {
        'calories': tdee,
        'carbs': (tdee * 0.4) / 4,
        'protein': (tdee * 0.3) / 4,
        'fat': (tdee * 0.3) / 9
    }

# 5. íŒŒì¼ ì½ê¸° í•¨ìˆ˜
def read_any_table(file_name, file_content):
    try:
        return pd.read_excel(io.BytesIO(file_content))
    except:
        pass
    for enc in ('cp949', 'utf-8-sig', 'utf-8'):
        try:
            return pd.read_csv(io.BytesIO(file_content), encoding=enc)
        except:
            continue
    return pd.read_csv(io.BytesIO(file_content))

# 6. AI ì‹ë‹¨ ì¶”ì²œ í•¨ìˆ˜ (100g ì‹ë‹¨ ê¸°ì¤€)
def recommend_meal_plan(db, targets, seed=None):
    db = db[db['carbon_g_per_100g'] <= 4000].copy()
    meals = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…']
    samples = []

    if seed is not None:
        random.seed(seed)

    for meal in meals:
        candidates = db[db['meal_type'].str.contains(meal, na=False)]
        if candidates.empty:
            return f"{meal} ì‹ë‹¨ í›„ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."
        samples.append(candidates.sample(1))

    plan_df = pd.concat(samples).reset_index(drop=True)
    portion_g = 350  # 1ì¸ë¶„ ê¸°ì¤€
    nutrients = ['calories', 'carbs', 'protein', 'fat', 'carbon_g_per_100g']
    plan_df[nutrients] = plan_df[nutrients].apply(lambda x: x * portion_g / 100)

    total = plan_df[nutrients].sum()

    return plan_df, total

# 7. UI ìœ„ì ¯
uploader = widgets.FileUpload(accept='.csv,.xlsx', multiple=False, description="DB ì—…ë¡œë“œ")
gender = widgets.Dropdown(options=['ë‚¨ì„±', 'ì—¬ì„±'], description='ì„±ë³„')
age = widgets.IntSlider(value=25, min=10, max=80, description='ë‚˜ì´')
height = widgets.IntSlider(value=170, min=140, max=200, description='í‚¤(cm)')
weight = widgets.IntSlider(value=65, min=30, max=150, description='ì²´ì¤‘(kg)')
activity = widgets.Dropdown(options=['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ'], description='í™œë™ëŸ‰')

run_button = widgets.Button(description='ğŸ± AI ì‹ë‹¨ ì¶”ì²œ', button_style='success')
refresh_button = widgets.Button(description='ğŸ”„ ìƒˆë¡œê³ ì¹¨', button_style='info')
output = widgets.Output()

# 8. ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
def run_recommendation(_):
    output.clear_output()
    with output:
        if not uploader.value:
            print("â— ì‹í’ˆ ë°ì´í„° íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.")
            return
        content = list(uploader.value.values())[0]['content']
        df = read_any_table("file", content)

        rename_map = {
            'ì‹í’ˆëª…': 'food_name',
            'ì—ë„ˆì§€(kcal)': 'calories',
            'ì—ë„ˆì§€(ã‰)': 'calories',
            'íƒ„ìˆ˜í™”ë¬¼(g)': 'carbs',
            'ë‹¨ë°±ì§ˆ(g)': 'protein',
            'ì§€ë°©(g)': 'fat',
            'meal_type': 'meal_type'
        }
        df.rename(columns={k: v for k, v in rename_map.items() if k in df.columns}, inplace=True)
        if 'food_name' not in df.columns:
            print("â— 'ì‹í’ˆëª…' ë˜ëŠ” 'food_name' ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            return
        df.drop_duplicates(subset=['food_name'], inplace=True)
        for col in ['calories', 'carbs', 'protein', 'fat']:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce')
        df.fillna(0, inplace=True)
        df['carbon_tags'] = df['food_name'].apply(get_carbon_tags)
        df['carbon_factor'] = df['carbon_tags'].apply(calculate_carbon_factor)
        df['carbon_g_per_100g'] = df['carbon_factor'] * 100

        user_targets = calculate_user_targets(gender.value, age.value, height.value, weight.value, activity.value)
        plan_df, total = recommend_meal_plan(df, user_targets, seed=np.random.randint(0, 100000))

        print("ğŸ‘¤ ê±´ê°• & ì €íƒ„ì†Œ AI ì‹ë‹¨ ì¶”ì²œê¸°")
        print("ğŸ“Œ 1ì¸ë¶„ ê¸°ì¤€ ì„­ì·¨ëŸ‰: 350g\n")
        for i, row in plan_df.iterrows():
            emoji = ["â˜€ï¸ ì•„ì¹¨", "ğŸŒ ì ì‹¬", "ğŸŒ™ ì €ë…"][i]
            print(f"{emoji}: {row['food_name']}  ({int(350)}g, {row['carbon_g_per_100g']:.2f} g COâ‚‚e)")

        print("\nğŸ“Š ì´ ì„­ì·¨ ìš”ì•½")
        print(f"  - ì—´ëŸ‰: {total['calories']:.0f} kcal")
        print(f"  - íƒ„ìˆ˜í™”ë¬¼: {total['carbs']:.0f} g")
        print(f"  - ë‹¨ë°±ì§ˆ: {total['protein']:.0f} g")
        print(f"  - ì§€ë°©: {total['fat']:.0f} g")
        print(f"  - íƒ„ì†Œë°°ì¶œëŸ‰: {total['carbon_g_per_100g'] / 1000:.2f} kg COâ‚‚e")

# ë²„íŠ¼ ì—°ê²°
run_button.on_click(run_recommendation)
refresh_button.on_click(run_recommendation)

# 9. UI ì¶œë ¥
ui = widgets.VBox([
    widgets.HTML("<h3>ğŸ€ ê±´ê°• & ì €íƒ„ì†Œ AI ì‹ë‹¨ ì¶”ì²œê¸°</h3>"),
    uploader, gender, age, height, weight, activity,
    widgets.HBox([run_button, refresh_button]),
    output
])
display(ui)
