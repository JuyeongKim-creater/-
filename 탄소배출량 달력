# ===================== Colab: 2025-08 ì›”ë³„ íƒ„ì†Œ ë°°ì¶œëŸ‰ ë‹¬ë ¥ (ë¼ë‹ˆë³„ ë¶„ì„) =====================
# ì„¤ëª…: 'ìš”ë¦¬_food_group_ë¶„ë¥˜ì™„ë£Œ.xlsx' íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì•„ì¹¨, ì ì‹¬, ì €ë… ì‹ë‹¨ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ê³ ,
#       ê° ë¼ë‹ˆë³„ë¡œ ë‹¨ê³„ì  íƒ„ì†Œ ë°°ì¶œëŸ‰ì„ ê³„ì‚°í•˜ì—¬ ë‹¬ë ¥ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.
import sys, os, re, calendar, random
from datetime import date
from IPython.display import display, HTML
import numpy as np
import pandas as pd
from google.colab import files

# -------- 1) ì‚¬ìš©ì ë°ì´í„° ì—…ë¡œë“œ + ê¸°ë³¸ ê²½ë¡œ --------
print("ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë ¤ë©´ íŒì—…ì—ì„œ 'ìš”ë¦¬_food_group_ë¶„ë¥˜ì™„ë£Œ.xlsx' íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.")
try:
    uploaded = files.upload()
    UP_FILES = list(uploaded.keys())
except Exception:
    UP_FILES = []

DEFAULT_FILE = "/mnt/data/ìš”ë¦¬_food_group_ë¶„ë¥˜ì™„ë£Œ.xlsx"

def load_food_data() -> pd.DataFrame:
    """
    ì—…ë¡œë“œëœ íŒŒì¼ ë˜ëŠ” ê¸°ë³¸ ê²½ë¡œì˜ ìŒì‹ ë°ì´í„° ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•©ë‹ˆë‹¤.
    """
    df = None
    if UP_FILES:
        try:
            df = pd.read_excel(UP_FILES[0])
        except Exception as e:
            print(f"âš  ì—…ë¡œë“œ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {e}")

    if df is None and os.path.exists(DEFAULT_FILE):
        try:
            df = pd.read_excel(DEFAULT_FILE)
        except Exception as e:
            print(f"âš  ê¸°ë³¸ ê²½ë¡œ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {e}")

    if df is None or df.empty:
        raise RuntimeError("ìŒì‹ ë°ì´í„° ì—‘ì…€ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. 'ìš”ë¦¬_food_group_ë¶„ë¥˜ì™„ë£Œ.xlsx' íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    df.columns = [str(c).strip() for c in df.columns]
    return df

# -------- 2) íƒ„ì†Œ ë°°ì¶œ ê³„ìˆ˜ ë°ì´í„° ì •ì˜ (ì´ë¯¸ì§€ ê¸°ë°˜) --------
EMISSION_FACTORS_RAW = {
    'stage': ['ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ë†ì¥', 'ê³µì¥', 'ê³µì¥', 'ê³µì¥', 'ìœ í†µ', 'ìœ í†µ', 'ìœ í†µ', 'ë§¤ì¥', 'ë§¤ì¥', 'ë§¤ì¥'],
    'item': ['ì†Œê³ ê¸°', 'ë¼ì§€ê³ ê¸°', 'ë‹­ê³ ê¸°', 'ê³„ë€', 'ìœ ì œí’ˆ', 'ìŒ€', 'ê³¼ì¼', 'ì±„ì†Œ', 'ìˆ˜ì‚°ë¬¼(ì–‘ì‹)', 'ìˆ˜ì‚°ë¬¼(ìì—°ì‚°)', 'ê°€ê³µ', 'ì‚´ê· /ë©¸ê· ', 'í¬ì¥', 'êµ­ì‚°(íŠ¸ëŸ­)', 'í•´ìƒìš´ì†¡', 'í•­ê³µìš´ì†¡', 'ëƒ‰ì¥/ëƒ‰ë™', 'ì¡°ëª… ë° ê¸°íƒ€', 'ì‹í’ˆ íê¸°'],
    'emission_factor': [48, 5.5, 4.8, 2.5, 2, 3, 0.4, 0.2, 3.5, 1.5, 0.4, 0.3, 0.2, 0.1, 2, 25, 0.2, 0.1, 0.2],
    'map_group': ['ìœ¡ë¥˜', 'ìœ¡ë¥˜', 'ìœ¡ë¥˜', 'ê³„ë€', 'ìœ ì œí’ˆ', 'ì£¼ì‹', 'ê³¼ì¼', 'ì±„ì†Œ', 'ìˆ˜ì‚°ë¬¼', 'ìˆ˜ì‚°ë¬¼', 'ê°€ê³µ', 'ì‚´ê· ', 'í¬ì¥', 'êµ­ì‚°', 'í•´ìƒ', 'í•­ê³µ', 'ëƒ‰ì¥', 'ê¸°íƒ€', 'íê¸°']
}
EMISSION_FACTORS = pd.DataFrame(EMISSION_FACTORS_RAW)

# -------- 3) ë°ì´í„° í‘œì¤€í™” ë° ì „ì²˜ë¦¬ --------
def normalize_food_data(df_raw: pd.DataFrame) -> pd.DataFrame:
    """
    ìŒì‹ ë°ì´í„°ì˜ ì»¬ëŸ¼ì„ í™•ì¸í•˜ê³ , 1íšŒ ì œê³µëŸ‰(g)ì„ íŒŒì‹±í•˜ì—¬ ìƒˆë¡œìš´ ì»¬ëŸ¼ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
    """
    df = df_raw.copy()
    required_cols = ['ì‹í’ˆëª…', 'ì˜ì–‘ì„±ë¶„í•¨ëŸ‰ê¸°ì¤€ëŸ‰', 'food_group', 'meal_type']
    if not all(col in df.columns for col in required_cols):
        raise ValueError(f"ì—‘ì…€ íŒŒì¼ì— í•„ìˆ˜ ì»¬ëŸ¼({required_cols})ì´ ëª¨ë‘ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í˜„ì¬ ì»¬ëŸ¼: {df.columns}")

    def parse_serving_g(s):
        s = str(s).lower()
        match = re.search(r'([\d\.]+)\s*g', s)
        if match: return float(match.group(1))
        match = re.search(r'([\d\.]+)\s*ml', s)
        if match: return float(match.group(1))
        return 100.0

    df['serving_g'] = df['ì˜ì–‘ì„±ë¶„í•¨ëŸ‰ê¸°ì¤€ëŸ‰'].apply(parse_serving_g)
    return df.dropna(subset=required_cols).reset_index(drop=True)

# -------- 4) ë¼ë‹ˆë³„ íƒ„ì†Œ ë°°ì¶œëŸ‰ ê³„ì‚° í•¨ìˆ˜ --------
# ğŸ”´ [ì˜¤ë¥˜ ìˆ˜ì •] food_groupì„ ë°°ì¶œ ê³„ìˆ˜ ê·¸ë£¹(map_group)ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ ì¶”ê°€
FOOD_GROUP_MAP = {
    'ì£¼ì‹': 'ì£¼ì‹',
    'êµ­/ì°Œê°œ': 'ìœ¡ë¥˜',       # ì£¼ ì¬ë£Œê°€ ìœ¡ë¥˜/ìˆ˜ì‚°ë¬¼ì¸ ê²½ìš°ê°€ ë§ë‹¤ê³  ê°€ì •
    'ë©”ì¸ë°˜ì°¬': 'ìœ¡ë¥˜',       # ì£¼ ì¬ë£Œê°€ ìœ¡ë¥˜/ìˆ˜ì‚°ë¬¼ì¸ ê²½ìš°ê°€ ë§ë‹¤ê³  ê°€ì •
    'ìƒëŸ¬ë“œ/ë¬´ì¹¨': 'ì±„ì†Œ',
    'ê¸°íƒ€ë°˜ì°¬': 'ì±„ì†Œ',
    'ìŒë£Œ': 'ê³¼ì¼'          # ê³¼ì¼ ì£¼ìŠ¤ ë“±ìœ¼ë¡œ ê°€ì •
}

def calculate_emission_for_meal(food: pd.Series, factors_df: pd.DataFrame, rng: random.Random):
    """
    í•˜ë‚˜ì˜ ìŒì‹ ë©”ë‰´ì— ëŒ€í•´ ë†ì¥-ê³µì¥-ìœ í†µ-ë§¤ì¥ ì „ ë‹¨ê³„ì˜ íƒ„ì†Œ ë°°ì¶œëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    """
    details = {}
    total_emission = 0.0
    food_kg = food['serving_g'] / 1000

    # 1. ë†ì¥
    # ğŸ”´ [ì˜¤ë¥˜ ìˆ˜ì •] food_groupì„ FOOD_GROUP_MAPì„ í†µí•´ map_keyë¡œ ë³€í™˜
    base_group = food['food_group'].split('/')[0]
    map_key = FOOD_GROUP_MAP.get(base_group, 'ì±„ì†Œ') # ë§µì— ì—†ëŠ” ê²½ìš° 'ì±„ì†Œ'ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
    
    factor_row = factors_df[(factors_df['stage'] == 'ë†ì¥') & (factors_df['map_group'] == map_key)]
    farm_emission = 0
    if not factor_row.empty:
        factor = factor_row.sample(1, random_state=rng.randint(1, 10**9)).iloc[0]
        farm_emission = factor['emission_factor'] * food_kg
    details['ë†ì¥'] = farm_emission
    total_emission += farm_emission

    # 2. ê³µì¥
    processing = factors_df[factors_df['map_group'] == 'ê°€ê³µ'].iloc[0]
    packaging = factors_df[factors_df['map_group'] == 'í¬ì¥'].iloc[0]
    factory_emission = (processing['emission_factor'] + packaging['emission_factor']) * food_kg
    details['ê³µì¥'] = factory_emission
    total_emission += factory_emission

    # 3. ìœ í†µ
    choice = rng.choices(['êµ­ì‚°', 'í•´ìƒ', 'í•­ê³µ'], weights=[70, 25, 5], k=1)[0]
    dist_method = factors_df[factors_df['map_group'] == choice].iloc[0]
    distance_km = {'êµ­ì‚°': 150, 'í•´ìƒ': 8000, 'í•­ê³µ': 10000}[choice]
    dist_emission = dist_method['emission_factor'] * (food_kg / 1000) * distance_km # t.km ë‹¨ìœ„
    details['ìœ í†µ'] = dist_emission
    total_emission += dist_emission

    # 4. ë§¤ì¥
    refrigeration = factors_df[factors_df['map_group'] == 'ëƒ‰ì¥'].iloc[0]
    food_waste = factors_df[factors_df['map_group'] == 'íê¸°'].iloc[0]
    store_emission = (refrigeration['emission_factor'] * food_kg) + (food_waste['emission_factor'] * food_kg * 0.1)
    details['ë§¤ì¥'] = store_emission
    total_emission += store_emission

    return {'food_name': food['ì‹í’ˆëª…'], 'total': total_emission, 'details': details, 'group': food['food_group']}

# -------- 5) ì¼ì¼ íƒ„ì†Œ ë°°ì¶œëŸ‰ ì‹œë®¬ë ˆì´ì…˜ (ë¡œì§ ìˆ˜ì •) --------
def simulate_daily_emissions(food_df: pd.DataFrame, factors_df: pd.DataFrame, rng: random.Random):
    """
    ì•„ì¹¨, ì ì‹¬, ì €ë… ê° ë¼ë‹ˆë³„ë¡œ 'ì£¼ì‹ + ë°˜ì°¬' ë©”ë‰´ë¥¼ ì„ íƒí•˜ê³  íƒ„ì†Œ ë°°ì¶œëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    """
    daily_plan = {}
    # 1. ì‹ë‹¨ êµ¬ì„±
    for meal_type in ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…']:
        meal_foods_info = []
        meal_total_emission = 0
        
        # 1-1. ì£¼ì‹ ì„ íƒ
        main_options = food_df[(food_df['meal_type'] == meal_type) & (food_df['food_group'] == 'ì£¼ì‹')]
        if not main_options.empty:
            chosen_main = main_options.sample(1, random_state=rng.randint(1, 10**9)).iloc[0]
            main_emission_info = calculate_emission_for_meal(chosen_main, factors_df, rng)
            meal_foods_info.append(main_emission_info)
            meal_total_emission += main_emission_info['total']

        # 1-2. ë°˜ì°¬ ì„ íƒ
        side_dish_groups = ['êµ­/ì°Œê°œ', 'ìƒëŸ¬ë“œ/ë¬´ì¹¨', 'ë©”ì¸ë°˜ì°¬', 'ê¸°íƒ€ë°˜ì°¬', 'ìŒë£Œ']
        side_options = food_df[(food_df['meal_type'] == meal_type) & (food_df['food_group'].isin(side_dish_groups))]
        if not side_options.empty:
            chosen_side = side_options.sample(1, random_state=rng.randint(1, 10**9)).iloc[0]
            side_emission_info = calculate_emission_for_meal(chosen_side, factors_df, rng)
            meal_foods_info.append(side_emission_info)
            meal_total_emission += side_emission_info['total']
            
        daily_plan[meal_type] = {'foods': meal_foods_info, 'total': meal_total_emission}

    # 2. ì¼ì¼ ì´í•© ê³„ì‚°
    daily_total = sum(v['total'] for v in daily_plan.values())
    daily_plan['total_emission'] = daily_total
    return daily_plan

# -------- 6) ë‹¬ë ¥ ìƒì„± + í‘œê¸° (ë¡œì§ ìˆ˜ì •) --------
def make_emission_calendar(year: int, month: int, seed: int = 123, show=True):
    food_raw = load_food_data()
    FOOD_DATA = normalize_food_data(food_raw)

    rng = random.Random(seed)
    last_day = calendar.monthrange(year, month)[1]
    days = [date(year, month, d) for d in range(1, last_day + 1)]

    plans = {}
    rows = []
    for d in days:
        daily_plan = simulate_daily_emissions(FOOD_DATA, EMISSION_FACTORS, rng)
        plans[d] = daily_plan
        rows.append({
            "date": pd.Timestamp(d),
            "total_emission_kg": daily_plan['total_emission'],
            "breakfast_kg": daily_plan.get('ì•„ì¹¨', {}).get('total', 0),
            "lunch_kg": daily_plan.get('ì ì‹¬', {}).get('total', 0),
            "dinner_kg": daily_plan.get('ì €ë…', {}).get('total', 0)
        })

    df_month = pd.DataFrame(rows).fillna(0)

    cgrid = calendar.monthcalendar(year, month)
    wk_names = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "]
    month_name = f"{year}ë…„ {month}ì›” íƒ„ì†Œ ë°œìêµ­"

    def cell_html(day_num):
        if day_num == 0: return "<td></td>"
        d = pd.Timestamp(date(year, month, day_num))
        row = df_month[df_month["date"] == d].iloc[0]
        total_kg = row["total_emission_kg"]
        b = row["breakfast_kg"]; l = row["lunch_kg"]; dn = row["dinner_kg"]
        
        plan = plans.get(d.date(), {})
        
        def get_meal_names(meal_type):
            foods = plan.get(meal_type, {}).get('foods', [])
            return " + ".join([f['food_name'] for f in foods]) or "ì—†ìŒ"

        b_name = get_meal_names('ì•„ì¹¨')
        l_name = get_meal_names('ì ì‹¬')
        d_name = get_meal_names('ì €ë…')
        tooltip = f"ì•„ì¹¨: {b_name} ({b:.2f}kg)&#10;ì ì‹¬: {l_name} ({l:.2f}kg)&#10;ì €ë…: {d_name} ({dn:.2f}kg)"

        return f"""
        <td style="vertical-align:top; width:120px; height:92px; padding:8px; border: 1px solid #eee;" title="{tooltip}">
          <div style="font-weight:600; margin-bottom:4px;">{day_num}</div>
          <div style="font-size:18px; font-weight:700; color:#c0392b;">{total_kg:.2f} kg</div>
          <div style="color:#666; font-size:11px;">{b:.1f}/{l:.1f}/{dn:.1f}</div>
        </td>"""

    html = f"""
    <div style="font-family: sans-serif; padding: 10px;">
        <div style="font-size:20px; font-weight:700; margin:8px 0;">íƒ„ì†Œ ë°°ì¶œëŸ‰ ë‹¬ë ¥ (ë¼ë‹ˆë³„ ë¶„ì„)</div>
        <div style="font-size:16px; margin-bottom:12px;">{month_name}</div>
        <table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse; width: 100%; text-align: center;">
          <thead><tr>{"".join(f'<th style="width:14.2%; padding:8px; color:#333; background-color:#f8f9fa;">{w}</th>' for w in wk_names)}</tr></thead>
          <tbody>{"".join("<tr>" + "".join(cell_html(dn) for dn in week) + "</tr>" for week in cgrid)}</tbody>
        </table>
    </div>"""

    if show: display(HTML(html))
    return df_month, plans, html

# -------- 7) ìƒì„¸ ë‚´ì—­ ì¶œë ¥ (ë¡œì§ ìˆ˜ì •) --------
def show_month_details(plans_dict, y, m):
    last_day = calendar.monthrange(y, m)[1]
    print("\n" + "="*20 + " ì¼ë³„ ìƒì„¸ ë°°ì¶œ ë‚´ì—­ " + "="*20)
    for d in range(1, last_day + 1):
        k = date(y, m, d)
        plan = plans_dict.get(k, {})
        total = plan.get('total_emission', 0)
        print(f"\nğŸ—“ï¸ [{y}-{m:02d}-{d:02d}] íƒ„ì†Œ ë°°ì¶œ ìƒì„¸ ë‚´ì—­ (ì´ {total:.2f} kg COâ‚‚eq)")
        for meal_type in ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…']:
            meal_info = plan.get(meal_type, {})
            if meal_info:
                meal_total = meal_info.get('total', 0)
                foods = meal_info.get('foods', [])
                food_names = " + ".join([f['food_name'] for f in foods]) or "ì—†ìŒ"
                print(f"  - {meal_type}: {food_names} (ì´ {meal_total:.2f} kg)")
                
                for food_item in foods:
                    details = food_item['details']
                    details_str = ", ".join([f"{stage} {em:.2f}kg" for stage, em in details.items()])
                    print(f"    â”” ({food_item['group']}) {food_item['food_name']}: {details_str}")

# ===================== ì‹¤í–‰: 2025ë…„ 8ì›” =====================
df_result, plans_result, _ = make_emission_calendar(2025, 8, seed=999, show=True)
show_month_details(plans_result, 2025, 8)
