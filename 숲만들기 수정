import ipywidgets as widgets
from IPython.display import display, SVG, clear_output
import random

# --- (ê³„ì‚° ë° SVG ìƒì„± í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼) ---
def calculate_forest_growth(last_month_co2, this_month_co2):
    reduction_kg = last_month_co2 - this_month_co2
    # ì´ í•¨ìˆ˜ëŠ” ì €ê°ëŸ‰ì´ ì–‘ìˆ˜ì¼ ë•Œë§Œ í˜¸ì¶œë  ê²ƒì´ë¯€ë¡œ, ìŒìˆ˜ ì²´í¬ëŠ” ìƒëµ ê°€ëŠ¥
    reduction_percent = (reduction_kg / last_month_co2) * 100
    trees_to_grow = []
    num_small_trees = int(reduction_percent / 5)
    for _ in range(num_small_trees):
        trees_to_grow.append({'size': 'small', 'emoji': 'ğŸŒ²'})
    num_big_trees = int(reduction_percent / 20)
    if num_big_trees > 0:
        trees_to_grow = trees_to_grow[num_big_trees * 4:]
        for _ in range(num_big_trees):
            trees_to_grow.append({'size': 'big', 'emoji': 'ğŸŒ³'})
    return trees_to_grow

def create_forest_svg(trees):
    svg_elements = '<rect width="400" height="300" style="fill:skyblue" />'
    svg_elements += '<rect y="250" width="400" height="50" style="fill:limegreen" />'
    if not trees:
        svg_elements += '<text x="100" y="150" font-size="20">íƒ„ì†Œ ì €ê° í™”ì´íŒ… <br/>ë‚˜ë§Œì˜ ìˆ²ì„ ê°€ê¿”ë³´ì„¸ìš”!</text>'
    for i, tree in enumerate(trees):
        random.seed(i)
        if tree['size'] == 'big':
            font_size, y_pos = 50, random.randint(200, 250)
        else: # small
            font_size, y_pos = 35, random.randint(220, 250)
        x_pos = random.randint(10, 360)
        svg_elements += f'<text x="{x_pos}" y="{y_pos}" font-size="{font_size}">{tree["emoji"]}</text>'
    return f'<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">{svg_elements}</svg>'

# --- 1. ì‚¬ìš©ì ì…ë ¥ì„ ìœ„í•œ ìœ„ì ¯(UI) ìƒì„± ---
last_month_input = widgets.FloatText(
    value=15.5,
    description='ì§€ë‚œë‹¬ ë°°ì¶œëŸ‰(kg):',
    style={'description_width': 'initial'}
)
this_month_input = widgets.FloatText(
    value=10.2,
    description='ì´ë²ˆ ë‹¬ ë°°ì¶œëŸ‰(kg):',
    style={'description_width': 'initial'}
)
run_button = widgets.Button(
    description="ğŸŒ³ ìˆ² ìƒì„±í•˜ê¸°",
    button_style='success'
)
output_area = widgets.Output() # ê²°ê³¼ê°€ í‘œì‹œë  ì˜ì—­

# --- 2. ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜ ì •ì˜ ---
def on_run_button_clicked(b):
    from IPython.display import SVG, display, clear_output
    with output_area:
        clear_output(wait=True)

        last_month_co2 = last_month_input.value
        this_month_co2 = this_month_input.value
        
        print(f"ì…ë ¥ê°’: ì§€ë‚œë‹¬ {last_month_co2} kg, ì´ë²ˆ ë‹¬ {this_month_co2} kg")
        
        # [ìˆ˜ì •] ì €ê°ëŸ‰ ì¡°ê±´ì— ë”°ë¼ ë‹¤ë¥¸ ë¡œì§ì„ ì‹¤í–‰í•˜ë„ë¡ ë³€ê²½
        if last_month_co2 > this_month_co2:
            # --- 1. íƒ„ì†Œë¥¼ ì €ê°í–ˆì„ ê²½ìš° ---
            reduction = last_month_co2 - this_month_co2
            print(f"âœ… íƒ„ì†Œ ì €ê°ëŸ‰: {reduction:.2f} kg COâ‚‚e ({(reduction/last_month_co2*100):.1f}% ê°ì†Œ)")

            trees = calculate_forest_growth(last_month_co2, this_month_co2)
            forest_image_svg = create_forest_svg(trees)

            print("\n--- ì´ë²ˆ ë‹¬ ë‚˜ì˜ ìˆ² ---")
            display(SVG(forest_image_svg))
        
        else:
            # --- 2. íƒ„ì†Œë¥¼ ì €ê°í•˜ì§€ ëª»í–ˆì„ ê²½ìš° ---
            print("âŒ ì´ë²ˆ ë‹¬ì—ëŠ” íƒ„ì†Œë¥¼ ì €ê°í•˜ì§€ ëª»í–ˆì–´ìš”.")
            
            # ë‚˜ë¬´ê°€ ì—†ëŠ” ë¹ˆ ìˆ² ì´ë¯¸ì§€ë¥¼ í‘œì‹œ
            empty_forest_svg = create_forest_svg([])
            print("\n--- ì´ë²ˆ ë‹¬ ë‚˜ì˜ ìˆ² ---")
            display(SVG(empty_forest_svg))


# --- 3. ë²„íŠ¼ê³¼ í•¨ìˆ˜ ì—°ê²° ë° UI í‘œì‹œ ---
run_button.on_click(on_run_button_clicked)

print("ì›”ê°„ íƒ„ì†Œ ë°°ì¶œëŸ‰(kg COâ‚‚e)ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
display(last_month_input, this_month_input, run_button, output_area)
